---
title: "Main analysis - SoCult"
author: "Anna Stuckert and Sofie Rødkjær"
date: "24/4/2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Load packages
```{r cars}
pacman::p_load(
  rethinking,
  brms,
  tidyverse,
  bayesplot,
  viridis,
  dplyr, 
  ggplot2,
  tibble, 
  boot,
  cowplot
)
```


## Load data

```{r pressure, echo=FALSE}
#set wd
# setwd("~/CogSci/4. semester/Social and Cultural Dynamics/Exam/Data/Exam experiment SocCult Anna og Sofie DONE/Social_and_Cultural_Dynamics_in_Cognition_Exam/Analysis and plot scripts/SoCult/")

#load data
d <- read_csv("Data_cleaned.csv")


##### Initial plots
# Duplicate Bot column 
d$Partner = d$BOT

# Overall cooperation rate for each partner (Bot)
ggplot(d, aes(BOT, PR, fill = Partner)) + geom_bar(stat= "summary") + geom_errorbar(stat="summary", fun.data=mean_se, width=0.3) + theme(legend.position= "none") + ggtitle("Player cooperation for each partner") + ylab("Player cooperation")

# Participant response as a function of time
ggplot(d, aes(x = Trial, y= PR, colour = Partner)) + geom_smooth(alpha = 0.2) + ggtitle("Player cooperation level as a function of time") + xlab("Time aka Trial") + ylab("Player cooperation")
```

## Define models
```{r}
### Baseline model
virk_f0 <- bf(PR ~ 1 + (1 | ID))

### Only BotReputation (Social_Rep)
virk_f1 <- bf(PR ~ 0 + Social_Rep + (0 + Social_Rep | ID))

### Only BotGender 
virk_f2 <- bf(PR ~ 0 + BotGender + (0 + BotGender | ID))

### Interaction between Social_Rep og BotGender 
virk_f3 <- bf(PR ~ 0 + Social_Rep : BotGender + (0 + Social_Rep : BotGender| ID))

### Effects of Programmed behavior and learning
virk_f4 <- bf(PR ~ 0 + Social_Rep:BotGender:BRprevious + (0 + Social_Rep:BotGender:BRprevious | ID))

virk_f5 <- bf(PR ~ 0 + Social_Rep:BotGender:Prog_Beh + (0 + Social_Rep:BotGender:Prog_Beh | ID))

virk_f6 <- bf(PR ~ 0 + Social_Rep:BotGender:Prog_Beh + Social_Rep:BotGender:Prog_Beh:mo(Trial) + (0 + Social_Rep:BotGender:Prog_Beh + Social_Rep:BotGender:Prog_Beh:mo(Trial) | ID))
```

############ MODELS ##############

##### Model 1
```{r}
#get prior
get_prior(virk_f1, d, family = bernoulli())

#set prior
prior_f1 <- c(
  prior(normal(0,1.5), class = b),
  prior(normal(0,0.3), class = sd)
) 

## Testing the prior in the model
m1_prior <- brm(
  virk_f1,
  d,
  family = bernoulli(),
  prior = prior_f1,
  sample_prior = "only",
  chains = 4, cores = 4,
  file = 'm1_prior'
)

## Standard pp_check
pp_check(m1_prior, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m1_prior)
dens(inv_logit(y_pred)) #densityplot that has been inverse logit-transformed

# Fitting the model
m1 <- brm(
  virk_f1,
  d,
  family = bernoulli(),
  prior = prior_f1,
  sample_prior = T,
  chains = 4, cores = 4,
  file = 'm1'
)

### model quality check
summary(m1)

# - trace plots and trace rank plots
color_scheme_set("viridis")

#Quick trace plots for all parameters
plot(m1)
pp_check(m1, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m1)
dens(inv_logit(y_pred))

#Checking parameter distributions
#extract the posteriors from the model: post <- posterior_samples(model)
post_m1 <- posterior_samples(m1)

#How much have the posterior betas and SD learned from data, compared to priors - density plots of prior vs posterior distributions

#b_Social_RepHigh
ggplot(post_m1) + geom_density(aes(post_m1$'prior_b', fill = "prior")) + geom_density(aes(post_m1$'b_Social_RepHigh', fill = "posterior")) + xlab("Parameter values")

#b_Social_RepLow
ggplot(post_m1) + geom_density(aes(post_m1$'prior_b', fill = "prior")) + geom_density(aes(post_m1$'b_Social_RepHigh', fill = "posterior"))+ xlab("Parameter values")

#sd_ID__Social_RepHigh
ggplot(post_m1) + geom_density(aes(post_m1$'sd_ID__Social_RepHigh', fill = "posterior")) + geom_density(aes(post_m1$'prior_sd_ID', fill = "prior"))+ xlab("Parameter values")


#sd_ID__Social_RepLow
ggplot(post_m1) + geom_density(aes(post_m1$'sd_ID__Social_RepLow', fill = "posterior")) + geom_density(aes(post_m1$'prior_sd_ID', fill = "prior"))+ xlab("Parameter values")
```

##### Model 2
```{r}
#get prior
get_prior(virk_f2, d, family = bernoulli())

#set prior
prior_f2 <- c(
  prior(normal(0,1.5), class = b),
  prior(normal(0,0.3), class = sd)
) 

## Testing the prior in the model
m2_prior <- brm(
  virk_f2,
  d,
  family = bernoulli(),
  prior = prior_f2,
  sample_prior = "only",
  chains = 4, cores = 4,
  file = 'm2_prior'
)

## Standard pp_check
pp_check(m2_prior, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m2_prior) 
dens(inv_logit(y_pred)) #densityplot that has been inverse logit-transformed

## Fitting the model
m2 <- brm(
  virk_f2,
  d,
  family = bernoulli(),
  prior = prior_f2,
  sample_prior = T,
  chains = 4, cores = 4,
  file = 'm2'
)

### model quality check
summary(m2)

# - trace plots and trace rank plots
color_scheme_set("viridis")

#Quick trace plots for all parameters
plot(m2)
pp_check(m2, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m2)
dens(inv_logit(y_pred))

#Checking parameter distributions
#extract the posteriors from the model: post <- posterior_samples(model)
post_m2 <- posterior_samples(m1)

#How much have the posterior betas and SD learned from data, compared to priors - density plots of prior vs posterior distributions

#b_BotGenderM
ggplot(post_m2) + geom_density(aes(post_m2$'prior_b', fill = "prior")) + geom_density(aes(post_m2$'b_BotGenderM', fill = "posterior")) + xlab("Parameter values")

#b_BotGenderF
ggplot(post_m2) + geom_density(aes(post_m2$'prior_b', fill = "prior")) + geom_density(aes(post_m2$'b_BotGenderF', fill = "posterior"))+ xlab("Parameter values")

#sd_ID__BotGenderM
ggplot(post_m2) + geom_density(aes(post_m2$'sd_ID__BotGenderM', fill = "posterior")) + geom_density(aes(post_m2$'prior_sd_ID', fill = "prior"))+ xlab("Parameter values")


#sd_ID__BotGenderF
ggplot(post_m2) + geom_density(aes(post_m2$'sd_ID__BotGenderF', fill = "posterior")) + geom_density(aes(post_m2$'prior_sd_ID', fill = "prior"))+ xlab("Parameter values")


```

##### Model 3
```{r}
#get prior
get_prior(virk_f3, d, family = bernoulli())

#set prior
prior_f3 <- c(
  prior(normal(0,1.5), class = b), 
  prior(normal(0,.3), class = sd)
) 

## Testing the prior
# Testing the prior in the model
m3_prior <- brm(
  virk_f3,
  d,
  family = bernoulli(),
  prior = prior_f3,
  sample_prior = "only",
  chains = 4, cores = 4,
  file = 'm3_prior'
)

## Standard pp_check
pp_check(m3_prior, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m3_prior) 
dens(inv_logit(y_pred)) #densityplot that has been inverse logit-transformed

# Fitting the model
m3 <- brm(
  virk_f3,
  d,
  family = bernoulli(),
  prior = prior_f3,
  sample_prior = T,
  chains = 4, cores = 4,
  file = 'm3'
)

### model quality check
summary(m3)

# - trace plots and trace rank plots
color_scheme_set("viridis")

#Quick trace plots for all parameters
plot(m3)
pp_check(m3, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m3)
dens(inv_logit(y_pred))

#extract the posteriors from the model: post <- posterior_samples(model)
post_m3 <- posterior_samples(m3)

#How much have the posterior betas and SD learned from data, compared to priors - density plots of prior vs posterior distributions

#b_Social_RepHigh_BotGenderF
ggplot(post_m3) + geom_density(aes(post_m3$'prior_b', fill = "prior")) + geom_density(aes(post_m3$'b_Social_RepHigh:BotGenderF', fill = "posterior")) + xlab("Parameter values")

#b_Social_RepHigh_BotGenderM 
ggplot(post_m3) + geom_density(aes(post_m3$'prior_b', fill = "prior")) + geom_density(aes(post_m3$'b_Social_RepHigh:BotGenderM', fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderF
ggplot(post_m3) + geom_density(aes(post_m3$'prior_b', fill = "prior")) + geom_density(aes(post_m3$'b_Social_RepLow:BotGenderF', fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderM
ggplot(post_m3) + geom_density(aes(post_m3$'prior_b', fill = "prior")) + geom_density(aes(post_m3$'b_Social_RepLow:BotGenderM', fill = "posterior")) + xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderF
ggplot(post_m3) + geom_density(aes(post_m3$'sd_ID__Social_RepHigh:BotGenderF', fill = "posterior")) + geom_density(aes(post_m3$'prior_sd_ID', fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderM
ggplot(post_m3) + geom_density(aes(post_m3$'sd_ID__Social_RepHigh:BotGenderM', fill = "posterior")) + geom_density(aes(post_m3$'prior_sd_ID', fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m3) + geom_density(aes(post_m3$'sd_ID__Social_RepLow:BotGenderF', fill = "posterior")) + geom_density(aes(post_m3$'prior_sd_ID', fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m3) + geom_density(aes(post_m3$'sd_ID__Social_RepLow:BotGenderM', fill = "posterior")) + geom_density(aes(post_m3$'prior_sd_ID', fill = "prior"))+ xlab("Parameter values")
```

##### MODEL COMPARISON 1 #########
```{r}
#adding LOO-criterion to each model
m1 <- add_criterion(m1, c("loo", "waic"))
m2 <- add_criterion(m2, c("loo", "waic"))
m3 <- add_criterion(m3, c("loo", "waic"))

#comparison
loo_compare(m1, m2, m3)

#stacking weights
loo_model_weights(m1, m2, m3)
```

##### Converting model estimates into probability space PHASE 1
```{r}
#We take the inverse logit of the log odds provided by the model (estimates) in order to transform the values into probability space.
#extract model summary 
sum3 <- summary(m3)
sum3

#To get population level estimates in inv_logit
df <- sum3[[14]]
df
str(df)
inv_logit(df)
```

##### Models with direct reciprocity
```{r}
#set prior for all models testing direct reciprocity
prior_dr <- c(
  prior(normal(0,1.5), class = b),
  prior(normal(0,.3), class = sd)
) 

#Running each model
### Model 4

# Prior
m4_prior <- brm(
  virk_f4,
  d,
  family = bernoulli(),
  prior = prior_dr,
  sample_prior = "only",
  chains = 4, cores = 4,
  file = 'm4_prior' 
)

# Standard pp_check
pp_check(m4_prior, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m4_prior) 
dens(inv_logit(y_pred)) #densityplot that has been inverse logit-transformed

# Fitting the model
m4 <- brm(
  virk_f4,
  d,
  family = bernoulli(),
  prior = prior_dr,
  sample_prior = T,
  chains = 4, cores = 4,
  file = 'm4' 
)

### model quality check
summary(m4)
color_scheme_set("viridis")

#Quick trace plots for all parameters
plot(m4)
pp_check(m4, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m4) 
dens(inv_logit(y_pred)) #densityplot that has been inverse logit-transformed

#extract the posteriors from the model: post <- posterior_samples(model)
post_m4 <- posterior_samples(m4)

# Rename columns, so they don't have ":"
colnames(post_m4)[colnames(post_m4) == "b_Social_RepHigh:BotGenderF:Prog_BehGood"] <- "b_Social_RepHigh_BotGenderF_Prog_BehGood"
colnames(post_m4)[colnames(post_m4) == "b_Social_RepHigh:BotGenderF:Prog_BehBad"] <- "b_Social_RepHigh_BotGenderF_Prog_BehBad"
colnames(post_m4)[colnames(post_m4) == "b_Social_RepHigh:BotGenderM:Prog_BehGood"] <- "b_Social_RepHigh_BotGenderM_Prog_BehGood"
colnames(post_m4)[colnames(post_m4) == "b_Social_RepHigh:BotGenderM:Prog_BehBad"] <- "b_Social_RepHigh_BotGenderM_Prog_BehBad"
colnames(post_m4)[colnames(post_m4) == "b_Social_RepLow:BotGenderF:Prog_BehGood"] <- "b_Social_RepLow_BotGenderF_Prog_BehGood"
colnames(post_m4)[colnames(post_m4) == "b_Social_RepLow:BotGenderF:Prog_BehBad"] <- "b_Social_RepLow_BotGenderF_Prog_BehBad"
colnames(post_m4)[colnames(post_m4) == "b_Social_RepLow:BotGenderM:Prog_BehGood"] <- "b_Social_RepLow_BotGenderM_Prog_BehGood"
colnames(post_m4)[colnames(post_m4) == "b_Social_RepLow:BotGenderM:Prog_BehBad"] <- "b_Social_RepLow_BotGenderM_Prog_BehBad"

#How much have the posterior betas and SD learned from data, compared to priors - density plots of prior vs posterior distributions

# GOOD BEHAVIOR
#b_Social_RepHigh_BotGenderF:Prog_BehGood
ggplot(post_m4) + geom_density(aes(post_m4$prior_b, fill = "prior")) + geom_density(aes(post_m4$b_Social_RepHigh_BotGenderF_Prog_BehGood, fill = "posterior")) + xlab("Parameter values")

#b_Social_RepHigh_BotGenderM_Prog_BehGood
ggplot(post_m4) + geom_density(aes(post_m4$prior_b, fill = "prior")) + geom_density(aes(post_m4$b_Social_RepHigh_BotGenderM_Prog_BehGood, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderF_Prog_BehGood
ggplot(post_m4) + geom_density(aes(post_m4$prior_b, fill = "prior")) + geom_density(aes(post_m4$b_Social_RepLow_BotGenderF_Prog_BehGood, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderM_Prog_BehGood
ggplot(post_m4) + geom_density(aes(post_m4$prior_b, fill = "prior")) + geom_density(aes(post_m4$b_Social_RepLow_BotGenderM_Prog_BehGood, fill = "posterior")) + xlab("Parameter values")

#sd_ID__Social_RepHigh_BotGenderF
ggplot(post_m4) + geom_density(aes(post_m4$'sd_ID__Social_RepHigh:BotGenderF:Prog_BehGood', fill = "posterior")) + geom_density(aes(post_m4$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderM
ggplot(post_m4) + geom_density(aes(post_m4$'sd_ID__Social_RepHigh:BotGenderM:Prog_BehGood', fill = "posterior")) + geom_density(aes(post_m4$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m4) + geom_density(aes(post_m4$'sd_ID__Social_RepLow:BotGenderF:Prog_BehGood', fill = "posterior")) + geom_density(aes(post_m4$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m4) + geom_density(aes(post_m4$'sd_ID__Social_RepLow:BotGenderM:Prog_BehGood', fill = "posterior")) + geom_density(aes(post_m4$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

# BAD BEHAVIOR

#b_Social_RepHigh_BotGenderF:Prog_BehBad
ggplot(post_m4) + geom_density(aes(post_m4$prior_b, fill = "prior")) + geom_density(aes(post_m4$b_Social_RepHigh_BotGenderF_Prog_BehBad, fill = "posterior")) + xlab("Parameter values")

#b_Social_RepHigh_BotGenderM_Prog_BehBad
ggplot(post_m4) + geom_density(aes(post_m4$prior_b, fill = "prior")) + geom_density(aes(post_m4$b_Social_RepHigh_BotGenderM_Prog_BehBad, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderF_Prog_BehBad
ggplot(post_m4) + geom_density(aes(post_m4$prior_b, fill = "prior")) + geom_density(aes(post_m4$b_Social_RepLow_BotGenderF_Prog_BehBad, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderM_Prog_BehBad
ggplot(post_m4) + geom_density(aes(post_m4$prior_b, fill = "prior")) + geom_density(aes(post_m4$b_Social_RepLow_BotGenderM_Prog_BehBad, fill = "posterior")) + xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderF
ggplot(post_m4) + geom_density(aes(post_m4$'sd_ID__Social_RepHigh:BotGenderF:Prog_BehBad', fill = "posterior")) + geom_density(aes(post_m4$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderM
ggplot(post_m4) + geom_density(aes(post_m4$'sd_ID__Social_RepHigh:BotGenderM:Prog_BehBad', fill = "posterior")) + geom_density(aes(post_m4$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m4) + geom_density(aes(post_m4$'sd_ID__Social_RepLow:BotGenderF:Prog_BehBad', fill = "posterior")) + geom_density(aes(post_m4$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m4) + geom_density(aes(post_m4$'sd_ID__Social_RepLow:BotGenderM:Prog_BehBad', fill = "posterior")) + geom_density(aes(post_m4$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

```

```{r}

### Model 5
# Prior
m5_prior <- brm(
  virk_f5,
  d,
  family = bernoulli(),
  prior = prior_dr,
  sample_prior = "only",
  chains = 4, cores = 4,
  file = 'm5_prior' 
)

# Standard pp_check
pp_check(m5_prior, nsamples = 50)

## Better pp_check
y_pred <- posterior_linpred(m5_prior) 
dens(inv_logit(y_pred)) #densityplot that has been inverse logit-transformed

#extract the posteriors from the model: post <- posterior_samples(model)
post_m5 <- posterior_samples(m5)

# Rename columns, so they don't have ":"
colnames(post_m5)[colnames(post_m5) == "b_Social_RepHigh:BotGenderF:BRpreviousCooperate"] <- "b_Social_RepHigh_BotGenderF_BRpreviousCooperate"
colnames(post_m5)[colnames(post_m5) == "b_Social_RepHigh:BotGenderF:BRpreviousDefect"] <- "b_Social_RepHigh_BotGenderF_BRpreviousDefect"
colnames(post_m5)[colnames(post_m5) == "b_Social_RepHigh:BotGenderM:BRpreviousCooperate"] <- "b_Social_RepHigh_BotGenderM_BRpreviousCooperate"
colnames(post_m5)[colnames(post_m5) == "b_Social_RepHigh:BotGenderM:BRpreviousDefect"] <- "b_Social_RepHigh_BotGenderM_BRpreviousDefect"
colnames(post_m5)[colnames(post_m5) == "b_Social_RepLow:BotGenderF:BRpreviousCooperate"] <- "b_Social_RepLow_BotGenderF_BRpreviousCooperate"
colnames(post_m5)[colnames(post_m5) == "b_Social_RepLow:BotGenderF:BRpreviousDefect"] <- "b_Social_RepLow_BotGenderF_BRpreviousDefect"
colnames(post_m5)[colnames(post_m5) == "b_Social_RepLow:BotGenderM:BRpreviousCooperate"] <- "b_Social_RepLow_BotGenderM_BRpreviousCooperate"
colnames(post_m5)[colnames(post_m5) == "b_Social_RepLow:BotGenderM:BRpreviousDefect"] <- "b_Social_RepLow_BotGenderM_BRpreviousDefect"

#How much have the posterior betas and SD learned from data, compared to priors - density plots of prior vs posterior distributions

# GOOD BEHAVIOR
#b_Social_RepHigh_BotGenderF:BRpreviousCooperate
ggplot(post_m5) + geom_density(aes(post_m5$prior_b, fill = "prior")) + geom_density(aes(post_m5$b_Social_RepHigh_BotGenderF_BRpreviousCooperate, fill = "posterior")) + xlab("Parameter values")

#b_Social_RepHigh_BotGenderM_BRpreviousCooperate
ggplot(post_m5) + geom_density(aes(post_m5$prior_b, fill = "prior")) + geom_density(aes(post_m5$b_Social_RepHigh_BotGenderM_BRpreviousCooperate, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderF_BRpreviousCooperate
ggplot(post_m5) + geom_density(aes(post_m5$prior_b, fill = "prior")) + geom_density(aes(post_m5$b_Social_RepLow_BotGenderF_BRpreviousCooperate, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderM_BRpreviousCooperate
ggplot(post_m5) + geom_density(aes(post_m5$prior_b, fill = "prior")) + geom_density(aes(post_m5$b_Social_RepLow_BotGenderM_BRpreviousCooperate, fill = "posterior")) + xlab("Parameter values")

#sd_ID__Social_RepHigh_BotGenderF
ggplot(post_m5) + geom_density(aes(post_m5$'sd_ID__Social_RepHigh:BotGenderF:BRpreviousCooperate', fill = "posterior")) + geom_density(aes(post_m5$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderM
ggplot(post_m5) + geom_density(aes(post_m5$'sd_ID__Social_RepHigh:BotGenderM:BRpreviousCooperate', fill = "posterior")) + geom_density(aes(post_m5$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m5) + geom_density(aes(post_m5$'sd_ID__Social_RepLow:BotGenderF:BRpreviousCooperate', fill = "posterior")) + geom_density(aes(post_m5$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m5) + geom_density(aes(post_m5$'sd_ID__Social_RepLow:BotGenderM:BRpreviousCooperate', fill = "posterior")) + geom_density(aes(post_m5$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

# BAD BEHAVIOR

#b_Social_RepHigh_BotGenderF:BRpreviousDefect
ggplot(post_m5) + geom_density(aes(post_m5$prior_b, fill = "prior")) + geom_density(aes(post_m5$b_Social_RepHigh_BotGenderF_BRpreviousDefect, fill = "posterior")) + xlab("Parameter values")

#b_Social_RepHigh_BotGenderM_BRpreviousDefect
ggplot(post_m5) + geom_density(aes(post_m5$prior_b, fill = "prior")) + geom_density(aes(post_m5$b_Social_RepHigh_BotGenderM_BRpreviousDefect, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderF_BRpreviousDefect
ggplot(post_m5) + geom_density(aes(post_m5$prior_b, fill = "prior")) + geom_density(aes(post_m5$b_Social_RepLow_BotGenderF_BRpreviousDefect, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderM_BRpreviousDefect
ggplot(post_m5) + geom_density(aes(post_m5$prior_b, fill = "prior")) + geom_density(aes(post_m5$b_Social_RepLow_BotGenderM_BRpreviousDefect, fill = "posterior")) + xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderF
ggplot(post_m5) + geom_density(aes(post_m5$'sd_ID__Social_RepHigh:BotGenderF:BRpreviousDefect', fill = "posterior")) + geom_density(aes(post_m5$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderM
ggplot(post_m5) + geom_density(aes(post_m5$'sd_ID__Social_RepHigh:BotGenderM:BRpreviousDefect', fill = "posterior")) + geom_density(aes(post_m5$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m5) + geom_density(aes(post_m5$'sd_ID__Social_RepLow:BotGenderF:BRpreviousDefect', fill = "posterior")) + geom_density(aes(post_m5$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m5) + geom_density(aes(post_m5$'sd_ID__Social_RepLow:BotGenderM:BRpreviousDefect', fill = "posterior")) + geom_density(aes(post_m5$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

````



```{r}
# Fitting the model
m5 <- brm(
  virk_f5,
  d,
  family = bernoulli(),
  prior = prior_dr,
  sample_prior = T,
  chains = 4, cores = 4,
  file = 'm5' 
)

### model quality check
summary(m5)
color_scheme_set("viridis")

#Quick trace plots for all parameters
plot(m5)
pp_check(m5, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m5) 
dens(inv_logit(y_pred)) #densityplot that has been inverse logit-transformed

```

```{r}

### Model 6
# Prior
m6_prior <- brm(
  virk_f6,
  d,
  family = bernoulli(),
  prior = prior_dr,
  sample_prior = "only",
  chains = 4, cores = 4,
  file = 'm6_prior' 
)

# Standard pp_check
pp_check(m6_prior, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m6_prior) 
dens(inv_logit(y_pred)) #densityplot that has been inverse logit-transformed

# Fitting the model
m6 <- brm(
  virk_f6,
  d,
  family = bernoulli(),
  prior = prior_dr,
  sample_prior = T,
  chains = 4, cores = 4,
  file = 'm6' 
)

### model quality check
# options(max.print = 10000)
print(summary(m6), digits = 5)

# - trace plots and trace rank plots
color_scheme_set("viridis")

#Quick trace plots for all parameters
plot(m6)

## posterior check
pp_check(m6, nsamples = 100)

## Better pp_check
y_pred <- posterior_linpred(m6)
dens(inv_logit(y_pred))


#How much have the posterior betas and SD learned from data, compared to priors - density plots of prior vs posterior distributions

#extract the posteriors from the model: post <- posterior_samples(model)
post_m6 <- posterior_samples(m6)

# Rename columns, so they don't have ":"
colnames(post_m6)[colnames(post_m6) == "b_Social_RepHigh:BotGenderF:Prog_BehGood"] <- "b_Social_RepHigh_BotGenderF_Prog_BehGood"
colnames(post_m6)[colnames(post_m6) == "b_Social_RepHigh:BotGenderF:Prog_BehBad"] <- "b_Social_RepHigh_BotGenderF_Prog_BehBad"
colnames(post_m6)[colnames(post_m6) == "b_Social_RepHigh:BotGenderM:Prog_BehGood"] <- "b_Social_RepHigh_BotGenderM_Prog_BehGood"
colnames(post_m6)[colnames(post_m6) == "b_Social_RepHigh:BotGenderM:Prog_BehBad"] <- "b_Social_RepHigh_BotGenderM_Prog_BehBad"
colnames(post_m6)[colnames(post_m6) == "b_Social_RepLow:BotGenderF:Prog_BehGood"] <- "b_Social_RepLow_BotGenderF_Prog_BehGood"
colnames(post_m6)[colnames(post_m6) == "b_Social_RepLow:BotGenderF:Prog_BehBad"] <- "b_Social_RepLow_BotGenderF_Prog_BehBad"
colnames(post_m6)[colnames(post_m6) == "b_Social_RepLow:BotGenderM:Prog_BehGood"] <- "b_Social_RepLow_BotGenderM_Prog_BehGood"
colnames(post_m6)[colnames(post_m6) == "b_Social_RepLow:BotGenderM:Prog_BehBad"] <- "b_Social_RepLow_BotGenderM_Prog_BehBad"
colnames(post_m6)[colnames(post_m6) == "bsp_Social_RepHigh:BotGenderF:Prog_BehGood:moTrial"] <- "bsp_Social_RepHigh_BotGenderF_Prog_BehGood_moTrial"
colnames(post_m6)[colnames(post_m6) == "bsp_Social_RepHigh:BotGenderF:Prog_BehBad:moTrial"] <- "bsp_Social_RepHigh_BotGenderF_Prog_BehBad_moTrial"
colnames(post_m6)[colnames(post_m6) == "bsp_Social_RepHigh:BotGenderM:Prog_BehGood:moTrial"] <- "bsp_Social_RepHigh_BotGenderM_Prog_BehGood_moTrial"
colnames(post_m6)[colnames(post_m6) == "bsp_Social_RepHigh:BotGenderM:Prog_BehBad:moTrial"] <- "bsp_Social_RepHigh_BotGenderM_Prog_BehBad_moTrial"
colnames(post_m6)[colnames(post_m6) == "bsp_Social_RepLow:BotGenderF:Prog_BehGood:moTrial"] <- "bsp_Social_RepLow_BotGenderF_Prog_BehGood_moTrial"
colnames(post_m6)[colnames(post_m6) == "bsp_Social_RepLow:BotGenderF:Prog_BehBad:moTrial"] <- "bsp_Social_RepLow_BotGenderF_Prog_BehBad_moTrial"
colnames(post_m6)[colnames(post_m6) == "bsp_Social_RepLow:BotGenderM:Prog_BehGood:moTrial"] <- "bsp_Social_RepLow_BotGenderM_Prog_BehGood_moTrial"
colnames(post_m6)[colnames(post_m6) == "bsp_Social_RepLow:BotGenderM:Prog_BehBad:moTrial"] <- "bsp_Social_RepLow_BotGenderM_Prog_BehBad_moTrial"

#adding mo_trial estimates to calculate parameter estimates for main effects
post_m6$b_Social_RepHigh_BotGenderF_Prog_BehGood <- post_m6$b_Social_RepHigh_BotGenderF_Prog_BehGood+(post_m6$bsp_Social_RepHigh_BotGenderF_Prog_BehGood_moTrial*80)
post_m6$b_Social_RepHigh_BotGenderM_Prog_BehGood <- post_m6$b_Social_RepHigh_BotGenderM_Prog_BehGood+(post_m6$bsp_Social_RepHigh_BotGenderM_Prog_BehGood_moTrial*80)
post_m6$b_Social_RepLow_BotGenderF_Prog_BehGood <- post_m6$b_Social_RepLow_BotGenderF_Prog_BehGood+(post_m6$bsp_Social_RepLow_BotGenderF_Prog_BehGood_moTrial*80)
post_m6$b_Social_RepLow_BotGenderM_Prog_BehGood <- post_m6$b_Social_RepLow_BotGenderM_Prog_BehGood+(post_m6$bsp_Social_RepLow_BotGenderM_Prog_BehGood_moTrial*80)
post_m6$b_Social_RepHigh_BotGenderF_Prog_BehBad <- post_m6$b_Social_RepHigh_BotGenderF_Prog_BehBad+(post_m6$bsp_Social_RepHigh_BotGenderF_Prog_BehBad_moTrial*80)
post_m6$b_Social_RepHigh_BotGenderM_Prog_BehBad <- post_m6$b_Social_RepHigh_BotGenderM_Prog_BehBad+(post_m6$bsp_Social_RepHigh_BotGenderM_Prog_BehBad_moTrial*80)
post_m6$b_Social_RepLow_BotGenderF_Prog_BehBad <- post_m6$b_Social_RepLow_BotGenderF_Prog_BehBad+(post_m6$bsp_Social_RepLow_BotGenderF_Prog_BehBad_moTrial*80)
post_m6$b_Social_RepLow_BotGenderM_Prog_BehBad <- post_m6$b_Social_RepLow_BotGenderM_Prog_BehBad+(post_m6$bsp_Social_RepLow_BotGenderM_Prog_BehBad_moTrial*80)

#How much have the posterior betas and SD learned from data, compared to priors - density plots of prior vs posterior distributions

# GOOD BEHAVIOR
#b_Social_RepHigh_BotGenderF:Prog_BehGood
ggplot(post_m6) + geom_density(aes(post_m6$prior_b, fill = "prior")) + geom_density(aes(post_m6$b_Social_RepHigh_BotGenderF_Prog_BehGood, fill = "posterior")) + xlab("Parameter values")

#b_Social_RepHigh_BotGenderM_Prog_BehGood
ggplot(post_m6) + geom_density(aes(post_m6$prior_b, fill = "prior")) + geom_density(aes(post_m6$b_Social_RepHigh_BotGenderM_Prog_BehGood, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderF_Prog_BehGood
ggplot(post_m6) + geom_density(aes(post_m6$prior_b, fill = "prior")) + geom_density(aes(post_m6$b_Social_RepLow_BotGenderF_Prog_BehGood, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderM_Prog_BehGood
ggplot(post_m6) + geom_density(aes(post_m6$prior_b, fill = "prior")) + geom_density(aes(post_m6$b_Social_RepLow_BotGenderM_Prog_BehGood, fill = "posterior")) + xlab("Parameter values")

#sd_ID__Social_RepHigh_BotGenderF
ggplot(post_m6) + geom_density(aes(post_m6$'sd_ID__Social_RepHigh:BotGenderF:Prog_BehGood', fill = "posterior")) + geom_density(aes(post_m6$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderM
ggplot(post_m6) + geom_density(aes(post_m6$'sd_ID__Social_RepHigh:BotGenderM:Prog_BehGood', fill = "posterior")) + geom_density(aes(post_m6$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m6) + geom_density(aes(post_m6$'sd_ID__Social_RepLow:BotGenderF:Prog_BehGood', fill = "posterior")) + geom_density(aes(post_m6$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m6) + geom_density(aes(post_m6$'sd_ID__Social_RepLow:BotGenderM:Prog_BehGood', fill = "posterior")) + geom_density(aes(post_m6$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

# BAD BEHAVIOR

#b_Social_RepHigh_BotGenderF:Prog_BehBad
ggplot(post_m6) + geom_density(aes(post_m6$prior_b, fill = "prior")) + geom_density(aes(post_m6$b_Social_RepHigh_BotGenderF_Prog_BehBad, fill = "posterior")) + xlab("Parameter values")

#b_Social_RepHigh_BotGenderM_Prog_BehBad
ggplot(post_m6) + geom_density(aes(post_m6$prior_b, fill = "prior")) + geom_density(aes(post_m6$b_Social_RepHigh_BotGenderM_Prog_BehBad, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderF_Prog_BehBad
ggplot(post_m6) + geom_density(aes(post_m6$prior_b, fill = "prior")) + geom_density(aes(post_m6$b_Social_RepLow_BotGenderF_Prog_BehBad, fill = "posterior"))+ xlab("Parameter values")

#b_Social_RepLow_BotGenderM_Prog_BehBad
ggplot(post_m6) + geom_density(aes(post_m6$prior_b, fill = "prior")) + geom_density(aes(post_m6$b_Social_RepLow_BotGenderM_Prog_BehBad, fill = "posterior")) + xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderF
ggplot(post_m6) + geom_density(aes(post_m6$'sd_ID__Social_RepHigh:BotGenderF:Prog_BehBad', fill = "posterior")) + geom_density(aes(post_m6$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepHigh:BotGenderM
ggplot(post_m6) + geom_density(aes(post_m6$'sd_ID__Social_RepHigh:BotGenderM:Prog_BehBad', fill = "posterior")) + geom_density(aes(post_m6$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m6) + geom_density(aes(post_m6$'sd_ID__Social_RepLow:BotGenderF:Prog_BehBad', fill = "posterior")) + geom_density(aes(post_m6$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

#sd_ID__Social_RepLow:BotGenderF
ggplot(post_m6) + geom_density(aes(post_m6$'sd_ID__Social_RepLow:BotGenderM:Prog_BehBad', fill = "posterior")) + geom_density(aes(post_m6$prior_sd_ID, fill = "prior"))+ xlab("Parameter values")

```


##### MODEL COMPARISON 2 #########
```{r}
#Adding LOO-criterion to each new model

m4 <- add_criterion(m4, c("loo", "waic"))
m5 <- add_criterion(m5, c("loo", "waic"))
m6 <- add_criterion(m6, c("loo", "waic"))

#Comparison
loo_compare(m3, m4, m5, m6)

#stacking weights
loo_model_weights(m3, m4, m5, m6)
```

##### Converting model estimates into probability space PHASE 2
```{r}
#We take the inverse logit of the log odds provided by the model (estimates) in order to transform the values into probability space.

#extract model summary
sum6 <- summary(m6)
sum6

#to get population level estimates in inv_logit
df <- sum6[[14]]
df
str(df)
inv_logit(df)
```
 
##### Hypotheses

Manual hypothesis testing in probability space

- Because we want to work in probability space we made a manual hypothesis testing procedure:
 . extract the posteriors from the model: post <- posterior_samples(model)
 . check the names of columns in post to see what things are called (in particular the ones starting w b)
 . perform the inv_logit on the b columns (to go to % space)
 . perform hypotheses test

Phase 1

```{r}
#extract the posteriors from the model: post <- posterior_samples(model)
post_p1 <- posterior_samples(m3)

#rename colums
colnames(post_p1)[colnames(post_p1) == "b_Social_RepHigh:BotGenderF"] <- "b_Social_RepHigh_BotGenderF"
colnames(post_p1)[colnames(post_p1) == "b_Social_RepHigh:BotGenderM"] <- "b_Social_RepHigh_BotGenderM"
colnames(post_p1)[colnames(post_p1) == "b_Social_RepLow:BotGenderF"] <- "b_Social_RepLow_BotGenderF"
colnames(post_p1)[colnames(post_p1) == "b_Social_RepLow:BotGenderM"] <- "b_Social_RepLow_BotGenderM"
post_p1$b_Social_RepHigh_BotGenderF <- inv_logit(post_p1$b_Social_RepHigh_BotGenderF)
post_p1$b_Social_RepHigh_BotGenderM <- inv_logit(post_p1$b_Social_RepHigh_BotGenderM)
post_p1$b_Social_RepLow_BotGenderF <- inv_logit(post_p1$b_Social_RepLow_BotGenderF)
post_p1$b_Social_RepLow_BotGenderM <- inv_logit(post_p1$b_Social_RepLow_BotGenderM)
post_p1 <- as.data.frame(post_p1)

#Hypothesis testing
## H1: People with high reputation are cooperated with more than people with low reputation
hypothesis(post_p1, "(b_Social_RepHigh_BotGenderM + b_Social_RepHigh_BotGenderF)/2 > 
           (b_Social_RepLow_BotGenderM + b_Social_RepLow_BotGenderF)/2")

plot(hypothesis(post_p1, "(b_Social_RepHigh_BotGenderM + b_Social_RepHigh_BotGenderF)/2 > 
           (b_Social_RepLow_BotGenderM + b_Social_RepLow_BotGenderF)/2"))


## H2: Female bots will be cooperated with more than male bots
hypothesis(post_p1, "(b_Social_RepHigh_BotGenderF + b_Social_RepLow_BotGenderF)/2 > 
           (b_Social_RepHigh_BotGenderM + b_Social_RepLow_BotGenderM)/2")

plot(hypothesis(post_p1, "(b_Social_RepHigh_BotGenderF + b_Social_RepLow_BotGenderF)/2 > 
           (b_Social_RepHigh_BotGenderM + b_Social_RepLow_BotGenderM)/2"))


## H3: Females with low reputation will be cooperated with more than male bots with low reputation
hypothesis(post_p1, "b_Social_RepLow_BotGenderF > b_Social_RepLow_BotGenderM")

hypothesis(post_p1, "b_Social_RepHigh_BotGenderM > b_Social_RepHigh_BotGenderF")

plot(hypothesis(post_p1, "b_Social_RepLow_BotGenderF > b_Social_RepLow_BotGenderM"))

plot(hypothesis(post_p1, "b_Social_RepHigh_BotGenderM > b_Social_RepHigh_BotGenderF"))
```

Phase 2
```{r}
#extract the posteriors from the model: post <- posterior_samples(model)
post_p2 <- posterior_samples(m6)

# Rename columns, so they don't have ":"
colnames(post_p2)[colnames(post_p2) == "b_Social_RepHigh:BotGenderF:Prog_BehGood"] <- "b_Social_RepHigh_BotGenderF_Prog_BehGood"
colnames(post_p2)[colnames(post_p2) == "b_Social_RepHigh:BotGenderF:Prog_BehBad"] <- "b_Social_RepHigh_BotGenderF_Prog_BehBad"
colnames(post_p2)[colnames(post_p2) == "b_Social_RepHigh:BotGenderM:Prog_BehGood"] <- "b_Social_RepHigh_BotGenderM_Prog_BehGood"
colnames(post_p2)[colnames(post_p2) == "b_Social_RepHigh:BotGenderM:Prog_BehBad"] <- "b_Social_RepHigh_BotGenderM_Prog_BehBad"
colnames(post_p2)[colnames(post_p2) == "b_Social_RepLow:BotGenderF:Prog_BehGood"] <- "b_Social_RepLow_BotGenderF_Prog_BehGood"
colnames(post_p2)[colnames(post_p2) == "b_Social_RepLow:BotGenderF:Prog_BehBad"] <- "b_Social_RepLow_BotGenderF_Prog_BehBad"
colnames(post_p2)[colnames(post_p2) == "b_Social_RepLow:BotGenderM:Prog_BehGood"] <- "b_Social_RepLow_BotGenderM_Prog_BehGood"
colnames(post_p2)[colnames(post_p2) == "b_Social_RepLow:BotGenderM:Prog_BehBad"] <- "b_Social_RepLow_BotGenderM_Prog_BehBad"
colnames(post_p2)[colnames(post_p2) == "bsp_Social_RepHigh:BotGenderF:Prog_BehGood:moTrial"] <- "bsp_Social_RepHigh_BotGenderF_Prog_BehGood_moTrial"
colnames(post_p2)[colnames(post_p2) == "bsp_Social_RepHigh:BotGenderF:Prog_BehBad:moTrial"] <- "bsp_Social_RepHigh_BotGenderF_Prog_BehBad_moTrial"
colnames(post_p2)[colnames(post_p2) == "bsp_Social_RepHigh:BotGenderM:Prog_BehGood:moTrial"] <- "bsp_Social_RepHigh_BotGenderM_Prog_BehGood_moTrial"
colnames(post_p2)[colnames(post_p2) == "bsp_Social_RepHigh:BotGenderM:Prog_BehBad:moTrial"] <- "bsp_Social_RepHigh_BotGenderM_Prog_BehBad_moTrial"
colnames(post_p2)[colnames(post_p2) == "bsp_Social_RepLow:BotGenderF:Prog_BehGood:moTrial"] <- "bsp_Social_RepLow_BotGenderF_Prog_BehGood_moTrial"
colnames(post_p2)[colnames(post_p2) == "bsp_Social_RepLow:BotGenderF:Prog_BehBad:moTrial"] <- "bsp_Social_RepLow_BotGenderF_Prog_BehBad_moTrial"
colnames(post_p2)[colnames(post_p2) == "bsp_Social_RepLow:BotGenderM:Prog_BehGood:moTrial"] <- "bsp_Social_RepLow_BotGenderM_Prog_BehGood_moTrial"
colnames(post_p2)[colnames(post_p2) == "bsp_Social_RepLow:BotGenderM:Prog_BehBad:moTrial"] <- "bsp_Social_RepLow_BotGenderM_Prog_BehBad_moTrial"

#adding mo_trial estimates to calculate parameter estimates for main effects
post_p2$b_Social_RepHigh_BotGenderF_Prog_BehGood <- post_p2$b_Social_RepHigh_BotGenderF_Prog_BehGood+(post_p2$bsp_Social_RepHigh_BotGenderF_Prog_BehGood_moTrial*80)
post_p2$b_Social_RepHigh_BotGenderM_Prog_BehGood <- post_p2$b_Social_RepHigh_BotGenderM_Prog_BehGood+(post_p2$bsp_Social_RepHigh_BotGenderM_Prog_BehGood_moTrial*80)
post_p2$b_Social_RepLow_BotGenderF_Prog_BehGood <- post_p2$b_Social_RepLow_BotGenderF_Prog_BehGood+(post_p2$bsp_Social_RepLow_BotGenderF_Prog_BehGood_moTrial*80)
post_p2$b_Social_RepLow_BotGenderM_Prog_BehGood <- post_p2$b_Social_RepLow_BotGenderM_Prog_BehGood+(post_p2$bsp_Social_RepLow_BotGenderM_Prog_BehGood_moTrial*80)
post_p2$b_Social_RepHigh_BotGenderF_Prog_BehBad <- post_p2$b_Social_RepHigh_BotGenderF_Prog_BehBad+(post_p2$bsp_Social_RepHigh_BotGenderF_Prog_BehBad_moTrial*80)
post_p2$b_Social_RepHigh_BotGenderM_Prog_BehBad <- post_p2$b_Social_RepHigh_BotGenderM_Prog_BehBad+(post_p2$bsp_Social_RepHigh_BotGenderM_Prog_BehBad_moTrial*80)
post_p2$b_Social_RepLow_BotGenderF_Prog_BehBad <- post_p2$b_Social_RepLow_BotGenderF_Prog_BehBad+(post_p2$bsp_Social_RepLow_BotGenderF_Prog_BehBad_moTrial*80)
post_p2$b_Social_RepLow_BotGenderM_Prog_BehBad <- post_p2$b_Social_RepLow_BotGenderM_Prog_BehBad+(post_p2$bsp_Social_RepLow_BotGenderM_Prog_BehBad_moTrial*80)

### Find estimates, error and CI
#estimate for each parameter
mean(post_p2$b_Social_RepHigh_BotGenderF_Prog_BehGood)
mean(post_p2$b_Social_RepHigh_BotGenderM_Prog_BehGood )
mean(post_p2$b_Social_RepLow_BotGenderF_Prog_BehGood)
mean(post_p2$b_Social_RepLow_BotGenderM_Prog_BehGood)
mean(post_p2$b_Social_RepHigh_BotGenderF_Prog_BehBad)
mean(post_p2$b_Social_RepHigh_BotGenderM_Prog_BehBad)
mean(post_p2$b_Social_RepLow_BotGenderF_Prog_BehBad)
mean(post_p2$b_Social_RepLow_BotGenderM_Prog_BehBad)

#estimated error for each parameter
sd(post_p2$b_Social_RepHigh_BotGenderF_Prog_BehGood)
sd(post_p2$b_Social_RepHigh_BotGenderM_Prog_BehGood)
sd(post_p2$b_Social_RepLow_BotGenderF_Prog_BehGood)
sd(post_p2$b_Social_RepLow_BotGenderM_Prog_BehGood)
sd(post_p2$b_Social_RepHigh_BotGenderF_Prog_BehBad)
sd(post_p2$b_Social_RepHigh_BotGenderM_Prog_BehBad)
sd(post_p2$b_Social_RepLow_BotGenderF_Prog_BehBad)
sd(post_p2$b_Social_RepLow_BotGenderM_Prog_BehBad)

#CI's for each parameter
quantile(post_p2$b_Social_RepHigh_BotGenderF_Prog_BehGood, c(.05, .95))
quantile(post_p2$b_Social_RepHigh_BotGenderM_Prog_BehGood , c(.05, .95))
quantile(post_p2$b_Social_RepLow_BotGenderF_Prog_BehGood, c(.05, .95))
quantile(post_p2$b_Social_RepLow_BotGenderM_Prog_BehGood, c(.05, .95))
quantile(post_p2$b_Social_RepHigh_BotGenderF_Prog_BehBad, c(.05, .95))
quantile(post_p2$b_Social_RepHigh_BotGenderM_Prog_BehBad, c(.05, .95))
quantile(post_p2$b_Social_RepLow_BotGenderF_Prog_BehBad, c(.05, .95))
quantile(post_p2$b_Social_RepLow_BotGenderM_Prog_BehBad, c(.05, .95))

#probability estimate for each parameter
inv_logit(mean(post_p2$b_Social_RepHigh_BotGenderF_Prog_BehGood))
inv_logit(mean(post_p2$b_Social_RepHigh_BotGenderM_Prog_BehGood))
inv_logit(mean(post_p2$b_Social_RepLow_BotGenderF_Prog_BehGood))
inv_logit(mean(post_p2$b_Social_RepLow_BotGenderM_Prog_BehGood))
inv_logit(mean(post_p2$b_Social_RepHigh_BotGenderF_Prog_BehBad))
inv_logit(mean(post_p2$b_Social_RepHigh_BotGenderM_Prog_BehBad))
inv_logit(mean(post_p2$b_Social_RepLow_BotGenderF_Prog_BehBad))
inv_logit(mean(post_p2$b_Social_RepLow_BotGenderM_Prog_BehBad))

#perform the inv_logit on the b columns (to go to % space)
post_p2$b_Social_RepHigh_BotGenderF_Prog_BehGood <- inv_logit(post_p2$b_Social_RepHigh_BotGenderF_Prog_BehGood)
post_p2$b_Social_RepHigh_BotGenderM_Prog_BehGood <- inv_logit(post_p2$b_Social_RepHigh_BotGenderM_Prog_BehGood)
post_p2$b_Social_RepLow_BotGenderF_Prog_BehGood <- inv_logit(post_p2$b_Social_RepLow_BotGenderF_Prog_BehGood)
post_p2$b_Social_RepLow_BotGenderM_Prog_BehGood <- inv_logit(post_p2$b_Social_RepLow_BotGenderM_Prog_BehGood)
post_p2$b_Social_RepHigh_BotGenderF_Prog_BehBad <- inv_logit(post_p2$b_Social_RepHigh_BotGenderF_Prog_BehBad)
post_p2$b_Social_RepHigh_BotGenderM_Prog_BehBad <- inv_logit(post_p2$b_Social_RepHigh_BotGenderM_Prog_BehBad)
post_p2$b_Social_RepLow_BotGenderF_Prog_BehBad <- inv_logit(post_p2$b_Social_RepLow_BotGenderF_Prog_BehBad)
post_p2$b_Social_RepLow_BotGenderM_Prog_BehBad <- inv_logit(post_p2$b_Social_RepLow_BotGenderM_Prog_BehBad)

summary(post_p2)

#hypothesis testing

## H5a: General effect of direct reciprocity?
hypothesis(post_p2, "b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepHigh_BotGenderM_Prog_BehGood +
           b_Social_RepLow_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood >
           
           b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepHigh_BotGenderM_Prog_BehBad +
           b_Social_RepLow_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad")

plot(hypothesis(post_p2, "b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepHigh_BotGenderM_Prog_BehGood +
           b_Social_RepLow_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood >
           
           b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepHigh_BotGenderM_Prog_BehBad +
           b_Social_RepLow_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad"))

#high - is there an effect of behavior for good reputation
hypothesis(post_p2, "b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepHigh_BotGenderM_Prog_BehGood >
           
           b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepHigh_BotGenderM_Prog_BehBad")

#low - is there an effect of behavior for bad reputation
hypothesis(post_p2, "b_Social_RepLow_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood >
           
           b_Social_RepLow_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad")

#h5b - different effects of prog_beh for social_rep
hypothesis(post_p2, "((b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepHigh_BotGenderM_Prog_BehGood)/2 -
           (b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepHigh_BotGenderM_Prog_BehBad)/2) >
           
           ((b_Social_RepLow_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood)/2 -
           (b_Social_RepLow_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad)/2)")

plot(hypothesis(post_p2, "((b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepHigh_BotGenderM_Prog_BehGood)/2 -
           (b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepHigh_BotGenderM_Prog_BehBad)/2) >
           
           ((b_Social_RepLow_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood)/2 -
           (b_Social_RepLow_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad)/2)"))


#h5c - different effects of prog_beh for males vs females

#hypothesis: difference between BehGood and BehBad is larger for males than females
hypothesis(post_p2, "((b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderF_Prog_BehGood)/2 -
           (b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderF_Prog_BehBad)/2) >
           
           ((b_Social_RepHigh_BotGenderM_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood)/2 -
           (b_Social_RepHigh_BotGenderM_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad)/2)")

plot(hypothesis(post_p2, "((b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderF_Prog_BehGood)/2 -
           (b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderF_Prog_BehBad)/2) >
           
           ((b_Social_RepHigh_BotGenderM_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood)/2 -
           (b_Social_RepHigh_BotGenderM_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad)/2)"))

#hypothesis: difference between BehGood and BehBad is larger for famales than males

hypothesis(post_p2, "((b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderF_Prog_BehGood)/2 -
           (b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderF_Prog_BehBad)/2) <
           
           ((b_Social_RepHigh_BotGenderM_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood)/2 -
           (b_Social_RepHigh_BotGenderM_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad)/2)")

plot(hypothesis(post_p2, "((b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderF_Prog_BehGood)/2 -
           (b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderF_Prog_BehBad)/2) <
           
           ((b_Social_RepHigh_BotGenderM_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood)/2 -
           (b_Social_RepHigh_BotGenderM_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad)/2)"))


```


MODEL PREDICTIONS  - REAL VS MODEL PREDICTED DATA 

M3

```{r}
# To get model predictions
predictions=predict(m3, type = "response")
d$prediction = predictions[,1]
d$PR <- as.numeric(d$PR)

# To make a plot comparing model predictions with actual data. Actual data = red, predictions = blue
dens(d$PR, col = "red") 
class(d$prediction)
dens(d$prediction, col = "blue")

# To create a confusion matrix to get accuracy
d$Predictionsm3[d$prediction>0.5]=1 
d$Predictionsm3[d$prediction<=0.5]=0
class(d$Predictionsm3)
class(d$PR)
d$Predictionsm3 <- as.factor(d$Predictionsm3)
d$PR <- as.factor(d$PR)
CM3 <- confusionMatrix(data = d$Predictionsm3, reference = d$PR)
CM3 #to see accuracy of the model
```

M6
```{r}
# To get model predictions
predictions=predict(m6, type = "response")
d$predictionm6 = predictions[,1]

# To make a plot comparing model predictions with actual data. Actual data = red, predictions = blue
dens(d$PR, col = "red") 
class(d$predict)
dens(d$predictionm6, col = "blue")

# To create a confusion matrix to get accuracy
d$Predictionsm6[d$predictionm6>0.5]=1 
d$Predictionsm6[d$predictionm6<=0.5]=0
class(d$Predictionsm6)
class(d$PR)
d$Predictionsm6 <- as.factor(d$Predictionsm6)
d$PR <- as.factor(d$PR)
CM6 <- confusionMatrix(data = d$Predictionsm6, reference = d$PR)
CM6 #to see accuracy of the model
```


For data plots, see plot code


##### Post Hoc
```{r}
# is the effect of BotGender still there when we use M6?
hypothesis(post_p2, "(b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderF_Prog_BehGood +
           b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderF_Prog_BehBad) >
           
           (b_Social_RepHigh_BotGenderM_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood +
           b_Social_RepHigh_BotGenderM_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad)")

## H3: Females with low reputation will be cooperated with more than male bots with low reputation, now with M6
hypothesis(post_p2, "(b_Social_RepLow_BotGenderF_Prog_BehGood +
          b_Social_RepLow_BotGenderF_Prog_BehBad)/2 > 
           
           (b_Social_RepLow_BotGenderM_Prog_BehGood +
          b_Social_RepLow_BotGenderM_Prog_BehBad)/2")

plot(hypothesis(post_p2, "(b_Social_RepLow_BotGenderF_Prog_BehGood +
          b_Social_RepLow_BotGenderF_Prog_BehBad)/2 > 
           
           (b_Social_RepLow_BotGenderM_Prog_BehGood +
          b_Social_RepLow_BotGenderM_Prog_BehBad)/2"))


## Males with high rep are cooperated with more than females with high rep, with M6
hypothesis(post_p2, "(b_Social_RepHigh_BotGenderM_Prog_BehGood +
            b_Social_RepHigh_BotGenderM_Prog_BehBad)/2 > 
           
           (b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepHigh_BotGenderF_Prog_BehBad)/2")

plot(hypothesis(post_p2, "(b_Social_RepHigh_BotGenderM_Prog_BehGood +
            b_Social_RepHigh_BotGenderM_Prog_BehBad)/2 > 
           
           (b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepHigh_BotGenderF_Prog_BehBad)/2")
)


#can we  still support H1 with M6?
hypothesis(post_p2, "(b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepHigh_BotGenderM_Prog_BehGood +
           b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepHigh_BotGenderM_Prog_BehBad) >
           
           (b_Social_RepLow_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood +
           b_Social_RepLow_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad)")

plot(hypothesis(post_p2, "(b_Social_RepHigh_BotGenderF_Prog_BehGood +
           b_Social_RepHigh_BotGenderM_Prog_BehGood +
           b_Social_RepHigh_BotGenderF_Prog_BehBad +
           b_Social_RepHigh_BotGenderM_Prog_BehBad) >
           
           (b_Social_RepLow_BotGenderF_Prog_BehGood +
           b_Social_RepLow_BotGenderM_Prog_BehGood +
           b_Social_RepLow_BotGenderF_Prog_BehBad +
           b_Social_RepLow_BotGenderM_Prog_BehBad)"))


##Is there an effect of participant gender?
#set formulas
posthoc_f_inter <- bf(PR ~ 0 + Social_Rep:BotGender:Gender + (0 + Social_Rep:BotGender:Gender | ID))

posthoc_f_main <- bf(PR ~ 0 + Social_Rep:BotGender + Gender + (0 + Social_Rep:BotGender + Gender | ID))

#set priors
prior_posthoc <- c(
  prior(normal(0,1.5), class = b), 
  prior(normal(0,.3), class = sd)
) 

## Testing the prior in the model
 post_inter_prior <- brm(
   posthoc_f_inter,
   d,
   family = bernoulli(),
   prior = prior_posthoc,
   sample_prior = "only",
   chains = 2, cores = 4
 )
 ## Standard pp_check
 pp_check(post_inter_prior, nsamples = 100)
 ## Better pp_check
 y_pred <- posterior_linpred(post_inter_prior) #gives a linear representation, somehow
 dens(inv_logit(y_pred)) #densityplot that has been inverse logit-transformed

## Fitting the model
post_inter <- brm(
  posthoc_f_main,
  d,
  family = bernoulli(),
  prior = prior_posthoc,
  sample_prior = T,
  chains = 2, cores =1
)

### model quality check
summary(post_inter)

 ## Better pp_check
 y_pred <- posterior_linpred(post_inter)
 dens(inv_logit(y_pred))

 ## Testing the prior in the model
post_main_prior <- brm(
  posthoc_f_main,
   d,
   family = bernoulli(),
   prior = prior_posthoc,
   sample_prior = "only",
   chains = 2, cores = 1
 )

## Standard pp_check
 pp_check(post_main_prior, nsamples = 100)
 ## Better pp_check
 y_pred <- posterior_linpred(post_main_prior) #gives a linear representation, somehow
 dens(inv_logit(y_pred)) #densityplot that has been inverse logit-transformed

# Fitting the model
post_main <- brm(
  posthoc_f_main,
  d,
  family = bernoulli(),
  prior = prior_posthoc,
  sample_prior = T,
  chains = 2, cores =1
)
### model quality check
summary(post_main)
 ## Better pp_check
y_pred <- posterior_linpred(post_main)
dens(inv_logit(y_pred))

#model comparison
post_inter <- add_criterion(m4, c("loo", "waic"))
post_main <- add_criterion(m4.5, c("loo", "waic"))


loo_compare(post_inter, post_main)
loo_model_weights(post_inter, post_main)

#We take the inverse logit of the log odds provided by the model (estimates) in order to transform the values into probability space.

#extract model summary
sum_post <- summary(post_main)
sum_post

#to get population level estimates in inv_logit
df1 <- sum_post[[14]]
df1
str(df1)
inv_logit(df1)


```

